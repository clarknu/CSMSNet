# 充电桩数据深度采集与缓存增强方案

本方案旨在全面增强 CSMS 对充电桩上报数据的捕获、分类和缓存能力，特别是针对 MeterValues（计量数据）、状态通知以及配置信息的深度利用。

## 1. 数据模型增强 (Data Model Enhancements)

将扩展现有的状态模型，以容纳更丰富的数据。

### 1.1 新增 BatteryStatus (电池状态)
专门用于存储从连接器上报的电池相关数据（BMS信息）。
*   **字段**: `SoC` (荷电状态), `Voltage` (电压), `Current` (电流), `Power` (功率), `Temperature` (温度), `EnergyCharged` (已充能量), `Capacity` (总容量).

### 1.2 扩展 ConnectorStatus (连接器状态)
*   **新增字段**:
    *   `Battery`: `BatteryStatus` 对象 (当连接车辆时非空).
    *   `InstantVoltage`, `InstantCurrent`, `InstantPower`: 实时电气参数缓存.
    *   `CurrentTransactionId`: 当前关联的事务ID.
    *   `VendorId`, `VendorErrorCode`: 补充更多厂商信息.

### 1.3 扩展 ChargePointStatus (充电桩状态)
*   **新增字段**:
    *   `FirmwareStatus`: 固件更新状态 (Downloading, Installed 等).
    *   `DiagnosticsStatus`: 诊断日志上传状态.
    *   `ConfigurationItems`: `Dictionary<string, string>` 缓存所有已知的配置项.
    *   `LocalAuthListVersion`: 本地鉴权列表版本.
    *   `PowerRating`: 额定功率.
    *   `ConnectorCount`: 连接器数量.
    *   `BasicInfo`: 包含 Model, Vendor 等基础信息的引用或副本.

### 1.4 扩展 Transaction (交易信息)
*   **新增字段**: `LastMeterValue`, `LastSoC`, `CurrentPower`, `CurrentVoltage`, `CurrentAmperage`, `LastUpdated` (最后更新时间).

## 2. 状态缓存接口更新 (State Cache Update)

修改 `IStateCache` 和 `StateCache` 以支持新数据的存储。
*   实现 `UpdateBatteryStatus(chargePointId, connectorId, batteryStatus)`.
*   实现 `UpdateConfiguration(chargePointId, key, value)`.
*   实现 `UpdateFirmwareStatus`, `UpdateDiagnosticsStatus`.
*   实现 `UpdateLocalListVersion`.

## 3. 消息处理增强 (Message Handler Enhancements)

修改 `RequestHandler.cs` 以深入解析上报报文。

*   **MeterValues (计量数据)**:
    *   遍历 `MeterValue` 数组，根据 `Measurand` (SoC, Power.Active.Import, Voltage, Current.Import 等) 提取数据.
    *   区分属于 **连接器/电池** 的数据 (如 SoC, BatteryVoltage) 和 **电网/桩** 的数据.
    *   更新 `ConnectorStatus` 中的实时数据和电池信息.
    *   更新 `Transaction` 中的快照数据.
*   **StatusNotification (状态通知)**:
    *   除了状态变更，记录详细的 `ErrorCode` 和 `Info`.
*   **FirmwareStatusNotification**: 更新充电桩的 `FirmwareStatus`.
*   **DiagnosticsStatusNotification**: 更新充电桩的 `DiagnosticsStatus`.

## 4. 自动询问与配置同步 (Auto-Interrogation & Sync)

### 4.1 初始询问 (ChargePointInterrogator)
创建一个新的服务 `ChargePointInterrogator`，监听 `OnBootNotification` (Accepted) 事件。
*   **动作**:
    *   发送 `GetConfiguration` (获取配置，如心跳间隔、连接器数量等).
    *   发送 `GetLocalListVersion` (如果支持).
    *   收到回复后，自动更新 `StateCache`.

### 4.2 配置下发同步
修改 `OcppAdapter.cs` 中的 `ChangeConfigurationAsync` 和 `SendLocalListAsync`。
*   **逻辑**: 当下发指令收到 `Accepted` 或 `Success` 响应时，立即更新本地 `StateCache` 中对应的值，确保缓存与设备状态一致。

## 5. 执行步骤

1.  **修改模型**: 编辑 `ChargePointState.cs`.
2.  **更新缓存逻辑**: 编辑 `IStateCache.cs` 和 `StateCache.cs`.
3.  **增强消息解析**: 编辑 `RequestHandler.cs` 实现 MeterValues 解析逻辑.
4.  **实现配置同步**: 编辑 `OcppAdapter.cs` 处理配置下发后的缓存更新.
5.  **实现自动询问**: 创建 `ChargePointInterrogator.cs` 并注册到服务容器.
6.  **文档更新**: 更新 `PROJECT_MANUAL.md`.
