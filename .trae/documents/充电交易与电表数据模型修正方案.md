# 充电交易与电表数据模型修正方案

根据您的指正，我将对现有的数据模型和关联关系进行如下修正：

## 1. 电表值归属修正

*   **问题**: 电表读数 (`Energy.Active.Import.Register`) 是物理连接器 (`Connector`) 的属性，而非电池 (`Battery`) 的属性。
*   **修正**: 
    *   确保 `BatteryStatus` 中不包含电表计量值（`EnergyCharged` 等字段如果指代累计电量，应属于连接器或交易）。
    *   `ConnectorStatus` 中应包含 `LastMeterValue`（最近一次电表读数），用于反映该连接器当前的物理读数。

## 2. 充电交易与连接器关联修正 (多连接器场景)

*   **现状**: `Transaction` 模型目前仅包含一个 `ConnectorId` 字段。
*   **修正**:
    *   修改 `Transaction` 类，将 `ConnectorId` 替换为 `ConnectorIds` 列表 (`List<int>`)，以支持单交易关联多个连接器（如双枪同充）。
    *   在 `Transaction` 中移除 `MeterCurrent`，改为 `TotalEnergyConsumed`（已消耗总电量）。
    *   **逻辑说明**: 由于多个连接器各自有独立的电表读数，交易对象无法简单存储一个“当前电表值”。它应该存储的是基于所有参与连接器的（当前读数 - 起始读数）之和计算出的“本次交易已充电量”。

## 3. 实体关联关系强化

*   **ChargePoint -> Connectors**: 维持现有 `Dictionary<int, ConnectorStatus>` 结构。
*   **Connector -> Battery**: 维持 `ConnectorStatus` 包含 `BatteryStatus` 对象。当车辆连接时，该对象非空。
*   **Connector -> Transaction**: 维持 `ConnectorStatus.CurrentTransactionId`。如果多个连接器服务于同一个交易，它们将指向同一个 `TransactionId`。
*   **Transaction -> Connectors**: 如上所述，增加 `ConnectorIds` 列表，明确该交易占用了哪些资源。

## 4. 执行计划

1.  **修改数据模型 (`ChargePointState.cs`)**:
    *   `BatteryStatus`: 移除 `EnergyCharged` (如果是指电表读数)。
    *   `ConnectorStatus`: 增加 `LastMeterValue` (int) 字段。
    *   `Transaction`: 
        *   将 `ConnectorId` (int) 改为 `ConnectorIds` (List\<int>)。
        *   将 `MeterStart` (int) 改为 `MeterStartValues` (Dictionary\<int, int>)，记录每个连接器的起始读数。
        *   将 `MeterCurrent` (int?) 改为 `TotalConsumedEnergy` (int?)，表示计算出的总耗电量。

2.  **更新接口与缓存逻辑 (`IStateCache.cs` & `StateCache.cs`)**:
    *   更新 `CreateTransaction`: 接受连接器列表和起始读数列表。
    *   更新 `UpdateTransactionMeter`: 逻辑变更为“接收某个连接器的当前读数 -> 计算该连接器的增量 -> 更新交易的总耗电量”。

3.  **更新请求处理 (`RequestHandler.cs`)**:
    *   `HandleStartTransaction`: 适配新的交易创建逻辑（目前协议 StartTransaction 请求通常只带一个 ConnectorId，多枪场景可能需要特殊处理逻辑，或者暂时只支持单枪但预留结构）。*注：标准 OCPP 1.6 StartTransaction 请求只有一个 ConnectorId。多枪同充通常是特定厂商扩展或通过主从事务处理。为了兼容标准并预留扩展，我们将 `ConnectorIds` 初始化为包含请求中的那个 ID。*
    *   `HandleMeterValues`: 更新连接器的 `LastMeterValue`，并重新计算交易的 `TotalConsumedEnergy`。

4.  **编译验证**: 确保修改后的代码编译通过。
