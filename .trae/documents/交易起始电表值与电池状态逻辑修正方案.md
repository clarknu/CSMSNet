# 交易起始电表值与电池状态逻辑修正方案

根据您的要求，我将对系统进行以下逻辑修正：

## 1. 交易起始电表值 (MeterStart) 逻辑修正

*   **现状**: 目前 `MeterStart` 仅在 `StartTransaction` 请求中获取一次，后续不再更新。
*   **新逻辑**:
    1.  **优先使用 `Transaction.Begin`**: 在 `HandleMeterValues` 中，如果收到的采样值上下文 (`Context`) 为 `Transaction.Begin` 且是电表读数 (`Energy.Active.Import.Register`)，则强制更新该交易对应连接器的 `MeterStartValue`。
    2.  **首个值兜底**: 如果交易创建时 `StartTransaction` 请求中的 `MeterStart` 为 0 或无效，且尚未收到过 `Transaction.Begin` 的值，则将**交易创建后收到的第一个**有效电表读数作为该连接器的起始值。
    3.  **计算逻辑**: 
        *   交易总电量 = (当前最新电表值 - 确定的起始电表值)。
        *   如果当前值小于起始值（如电表回滚），则视为 0 或异常处理。

## 2. 电池状态 (BatteryStatus) 字段精简

*   **现状**: `BatteryStatus` 包含了 `EnergyCharged` 和 `Capacity` 等字段。
*   **新逻辑**: 仅保留可以通过 `MeterValues` 报文直接获取的物理测量值。
    *   **保留**: `SoC` (荷电状态), `Voltage` (电压), `Current` (电流), `Power` (功率), `Temperature` (温度)。
    *   **移除**: `EnergyCharged` (已充能量 - 这是计算值或电表属性), `Capacity` (电池容量 - 协议中无标准 Measurand 直接上报容量数值，通常是 BMS 数据，标准 MeterValues 不含此项)。

## 3. 执行计划

1.  **修改数据模型 (`ChargePointState.cs`)**:
    *   `BatteryStatus`: 移除 `EnergyCharged` 和 `Capacity` 属性。
    *   `Transaction`: 增加逻辑或标记位，用于判断是否已经设定了“正式”的起始电表值（例如 `HasSetOfficialMeterStart` 字典）。

2.  **修改状态缓存逻辑 (`StateCache.cs`)**:
    *   修改 `UpdateTransactionMeter` 方法：增加参数 `context` (ReadingContext)。
    *   **逻辑实现**:
        *   如果 `context == Transaction.Begin`，无条件更新 `MeterStartValues[connectorId]`。
        *   如果 `MeterStartValues[connectorId]` 尚未设置（或为0/初始值），且收到有效读数，则将其设为起始值。
        *   计算 `TotalConsumedEnergy` 时使用最新的起始值。

3.  **修改请求处理逻辑 (`RequestHandler.cs`)**:
    *   `HandleMeterValuesAsync`:
        *   解析 `SampledValue` 时提取 `Context`。
        *   移除对 `EnergyCharged` 和 `Capacity` 的解析代码。
        *   调用 `_stateCache.UpdateTransactionMeter` 时传入解析出的 `Context`。

4.  **编译验证**: 确保代码修改后编译通过。
