# 充电桩数据模型与枚举类型修正方案

根据您的反馈和对 OCPP 1.6 协议的深入核查，我制定了以下修正方案。

## 1. 充电交易模型 (Transaction) 修正

*   **问题**: 原有设计在 `Transaction` 中混入了单连接器的电气属性 (`LastSoC`, `CurrentVoltage`, `CurrentAmperage`)，在多连接器或聚合场景下不适用且不符合协议定义。
*   **解决方案**:
    *   移除 `Transaction` 类中的 `LastSoC`, `CurrentVoltage`, `CurrentAmperage` 字段。
    *   保留 `CurrentPower` 字段，作为交易关联的总功率（聚合值）。
    *   保留 `MeterStart` 和 `MeterCurrent`，因为它们是交易计费的核心依据。

## 2. 状态缓存类型 (Status Cache Types) 修正

*   **问题**: `ChargePointStatus` 类中的 `FirmwareStatus` 和 `DiagnosticsStatus` 目前定义为 `string`，而协议有明确的枚举定义。
*   **解决方案**:
    *   将 `FirmwareStatus` 属性类型从 `string` 修改为 `CSMSNet.OcppAdapter.Models.V16.Enums.FirmwareStatus`。
    *   将 `DiagnosticsStatus` 属性类型从 `string` 修改为 `CSMSNet.OcppAdapter.Models.V16.Enums.DiagnosticsStatus`。
    *   确保相关枚举已正确定义在 `OcppEnums.cs` 中。

## 3. 电池状态 (BatteryStatus) 确认

*   **确认**: OCPP 1.6 协议确实支持 `Temperature` 作为测量值 (`Measurand`)，并且支持 `Celsius` 单位。通常当 `Location` 为 `EV` 时，这代表电池温度。
*   **行动**: 保留 `BatteryStatus` 中的 `Temperature` 字段，用于记录上报的电池温度。

## 4. 执行步骤

### 4.1 修改数据模型 (ChargePointState.cs)
*   **文件**: [ChargePointState.cs](file:///c:/Code/CSMSNet/src/CSMSNet.Ocpp/Models/State/ChargePointState.cs)
*   **修改**:
    *   `Transaction` 类：移除 `LastSoC`, `CurrentVoltage`, `CurrentAmperage`。保留 `CurrentPower`。
    *   `ChargePointStatus` 类：将 `FirmwareStatus` 和 `DiagnosticsStatus` 类型改为枚举（可空）。

### 4.2 更新状态缓存接口与实现
*   **文件**: [IStateCache.cs](file:///c:/Code/CSMSNet/src/CSMSNet.Ocpp/Abstractions/IStateCache.cs), [StateCache.cs](file:///c:/Code/CSMSNet/src/CSMSNet.Ocpp/State/StateCache.cs)
*   **修改**:
    *   更新 `UpdateFirmwareStatus` 和 `UpdateDiagnosticsStatus` 方法签名，接受枚举类型参数。
    *   更新 `UpdateTransactionSnapshot` 方法签名，移除已删除的参数。

### 4.3 修正请求处理逻辑 (RequestHandler.cs)
*   **文件**: [RequestHandler.cs](file:///c:/Code/CSMSNet/src/CSMSNet.Ocpp/Handlers/RequestHandler.cs)
*   **修改**:
    *   在 `HandleMeterValuesAsync` 中，不再向 `Transaction` 更新 SoC、电压和电流，仅更新功率。
    *   在 `HandleFirmwareStatusNotificationAsync` 和 `HandleDiagnosticsStatusNotificationAsync` 中，直接传递枚举值给缓存层。

### 4.4 验证与构建
*   执行 `dotnet build` 确保所有类型变更后的代码能正确编译。
